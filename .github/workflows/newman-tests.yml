name: Run API Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  api-test:
    name: BPS API Tests
    runs-on: [self-hosted, ubuntu]

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Verify Environment
        run: |
          echo "Node: $(node --version)"
          echo "Newman: $(newman --version)"
          pwd
          ls -la

      - name: ðŸ“¦ Create Directories
        run: |
          mkdir -p reports logs

      - name: ðŸ§ª Run Newman Tests
        continue-on-error: true
        id: newman
        env:
          BPS_API_KEY: ${{ secrets.BPS_API_KEY }}
          BPS_DOMAIN: ${{ secrets.DOMAIN_VALUE }}
        run: |
          newman run collections/API_BPS_Complete_with_negative_tests.json \
            --env-var "API_KEY=$BPS_API_KEY" \
            --env-var "DOMAIN_VALUE=$BPS_DOMAIN" \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export reports/report-${{ github.run_number }}.html \
            --delay-request 500 \
            --suppress-exit-code \
            --iteration-count 1 \
            --timeout-request 10000

      - name: ðŸ“¤ Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_number }}
          path: reports/*.html
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Run #${{ github.run_number }} completed" >> $GITHUB_STEP_SUMMARY
          echo "Download report from artifacts above" >> $GITHUB_STEP_SUMMARY
