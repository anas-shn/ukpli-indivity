name: BPS API Tests IndivityTeam

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM
  workflow_dispatch:

jobs:
  api-test:
    name: Run API Tests
    runs-on: [self-hosted, ubuntu, newman] # Use your self-hosted runner

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîç Verify Newman Installation
        run: |
          node --version
          npm --version
          newman --version

      - name: üì¶ Setup Test Environment
        run: |
          mkdir -p reports logs
          echo "Test environment ready"

      - name: üß™ Run Newman Tests
        env:
          BPS_API_KEY: ${{ secrets.BPS_API_KEY }}
          BPS_DOMAIN: ${{ secrets.BPS_DOMAIN }}
        run: |
          newman run collections/API_BPS_Complete_with_negative_tests.json \
            --env-var "API_KEY=$BPS_API_KEY" \
            --env-var "DOMAIN_VALUE=$BPS_DOMAIN" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/test-report-${{ github.run_number }}.html \
            --reporter-junit-export reports/junit-report-${{ github.run_number }}.xml \
            --delay-request 500 \
            --timeout-request 10000

      - name: üìä Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/junit-report-*.xml
          check_name: API Test Results

      - name: üì§ Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_number }}
          path: reports/test-report-*.html
          retention-days: 30

      - name: üí¨ Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "üö® BPS API Tests Failed!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå API Tests Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Run:*\n#${{ github.run_number }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "View Run"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }'
